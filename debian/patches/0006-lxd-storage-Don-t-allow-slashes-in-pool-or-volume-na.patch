From 152e87df9cc068c36847eb9a1aba2ac92975364c Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?St=C3=A9phane=20Graber?= <stgraber@ubuntu.com>
Date: Tue, 2 Jan 2018 18:44:04 +0100
Subject: lxd/storage: Don't allow slashes in pool or volume names
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Closes: #4127

Signed-off-by: St√©phane Graber <stgraber@ubuntu.com>
---
 lxd/storage_pools.go   | 4 ++++
 lxd/storage_volumes.go | 9 +++++++++
 2 files changed, 13 insertions(+)

diff --git a/lxd/storage_pools.go b/lxd/storage_pools.go
index b08e0125..6d4d80bc 100644
--- a/lxd/storage_pools.go
+++ b/lxd/storage_pools.go
@@ -73,6 +73,10 @@ func storagePoolsPost(d *Daemon, r *http.Request) Response {
 		return BadRequest(fmt.Errorf("No name provided"))
 	}
 
+	if strings.Contains(req.Name, "/") {
+		return BadRequest(fmt.Errorf("Storage pool names may not contain slashes"))
+	}
+
 	if req.Driver == "" {
 		return BadRequest(fmt.Errorf("No driver provided"))
 	}
diff --git a/lxd/storage_volumes.go b/lxd/storage_volumes.go
index 32bdd955..480029c4 100644
--- a/lxd/storage_volumes.go
+++ b/lxd/storage_volumes.go
@@ -5,6 +5,7 @@ import (
 	"fmt"
 	"net/http"
 	"strconv"
+	"strings"
 
 	"github.com/gorilla/mux"
 	"github.com/lxc/lxd/lxd/db"
@@ -154,6 +155,10 @@ func storagePoolVolumesTypePost(d *Daemon, r *http.Request) Response {
 		return BadRequest(fmt.Errorf("No name provided"))
 	}
 
+	if strings.Contains(req.Name, "/") {
+		return BadRequest(fmt.Errorf("Storage volume names may not contain slashes"))
+	}
+
 	// Check that the user gave use a storage volume type for the storage
 	// volume we are about to create.
 	if req.Type == "" {
@@ -213,6 +218,10 @@ func storagePoolVolumeTypePost(d *Daemon, r *http.Request) Response {
 		return BadRequest(fmt.Errorf("No name provided"))
 	}
 
+	if strings.Contains(req.Name, "/") {
+		return BadRequest(fmt.Errorf("Storage volume names may not contain slashes"))
+	}
+
 	// We currently only allow to create storage volumes of type
 	// storagePoolVolumeTypeCustom. So check, that nothing else was
 	// requested.
