From 82380d0390cdb21cbcf28b765fb19b3d6c58bdaf Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?St=C3=A9phane=20Graber?= <stgraber@ubuntu.com>
Date: Thu, 5 Oct 2017 12:59:14 -0400
Subject: Fix bad DB schema update between schema 30 and 31
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Closes #3878
Closes #3890

Signed-off-by: St√©phane Graber <stgraber@ubuntu.com>
---
 lxd/db/schema/schema.go | 14 ++++++++++++++
 1 file changed, 14 insertions(+)

diff --git a/lxd/db/schema/schema.go b/lxd/db/schema/schema.go
index d80f37db..795bc6af 100644
--- a/lxd/db/schema/schema.go
+++ b/lxd/db/schema/schema.go
@@ -7,6 +7,7 @@ import (
 	"strings"
 
 	"github.com/lxc/lxd/lxd/db/query"
+	"github.com/lxc/lxd/shared"
 )
 
 // Schema captures the schema of a database in terms of a series of ordered
@@ -164,6 +165,19 @@ func ensureUpdatesAreApplied(tx *sql.Tx, updates []Update, hook Hook) error {
 		return fmt.Errorf("failed to fetch update versions: %v", err)
 	}
 
+	// Fix bad upgrade code between 30 and 32
+	if shared.IntInSlice(30, versions) && shared.IntInSlice(32, versions) && !shared.IntInSlice(31, versions) {
+		err = insertSchemaVersion(tx, 31)
+		if err != nil {
+			return fmt.Errorf("failed to insert missing schema version 31")
+		}
+
+		versions, err = selectSchemaVersions(tx)
+		if err != nil {
+			return fmt.Errorf("failed to fetch update versions: %v", err)
+		}
+	}
+
 	current := 0
 	if len(versions) > 0 {
 		err = checkSchemaVersionsHaveNoHoles(versions)
