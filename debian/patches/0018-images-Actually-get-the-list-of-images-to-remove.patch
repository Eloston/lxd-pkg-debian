From faefd5855ebc4337ecdc2b2174edbd34e4eaa5e0 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?St=C3=A9phane=20Graber?= <stgraber@ubuntu.com>
Date: Thu, 5 Oct 2017 18:44:18 -0400
Subject: images: Actually get the list of images to remove
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: St√©phane Graber <stgraber@ubuntu.com>
---
 lxd/db/images.go | 2 +-
 lxd/images.go    | 5 +++--
 2 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/lxd/db/images.go b/lxd/db/images.go
index 9f6d00a6..c1b1fa47 100644
--- a/lxd/db/images.go
+++ b/lxd/db/images.go
@@ -76,7 +76,7 @@ func ImagesGetExpired(db *sql.DB, expiry int64) ([]string, error) {
 		results = append(results, r[0].(string))
 	}
 
-	return []string{}, nil
+	return results, nil
 }
 
 func ImageSourceInsert(db *sql.DB, imageId int, server string, protocol string, certificate string, alias string) error {
diff --git a/lxd/images.go b/lxd/images.go
index c7ebdbca..aacbf8ea 100644
--- a/lxd/images.go
+++ b/lxd/images.go
@@ -1006,14 +1006,15 @@ func autoUpdateImage(d *Daemon, op *operation, id int, info *api.Image) error {
 }
 
 func pruneExpiredImages(d *Daemon) {
-	logger.Infof("Pruning expired images")
-
 	// Get the list of expired images.
 	expiry := daemonConfig["images.remote_cache_expiry"].GetInt64()
+
+	// Check if we're supposed to prune something
 	if expiry <= 0 {
 		return
 	}
 
+	logger.Infof("Pruning expired images")
 	images, err := db.ImagesGetExpired(d.db, expiry)
 	if err != nil {
 		logger.Error("Unable to retrieve the list of expired images", log.Ctx{"err": err})
