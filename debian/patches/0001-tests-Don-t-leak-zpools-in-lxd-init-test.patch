From 0031bb31d708f127d2bc28f8f5d5b7decf8e471e Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?St=C3=A9phane=20Graber?= <stgraber@ubuntu.com>
Date: Fri, 24 Feb 2017 02:45:06 -0500
Subject: tests: Don't leak zpools in "lxd init" test
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: St√©phane Graber <stgraber@ubuntu.com>
---
 test/suites/init.sh | 22 ++++++++--------------
 1 file changed, 8 insertions(+), 14 deletions(-)

diff --git a/test/suites/init.sh b/test/suites/init.sh
index 8eebdea..1e06b9a 100644
--- a/test/suites/init.sh
+++ b/test/suites/init.sh
@@ -8,51 +8,45 @@ test_lxd_autoinit() {
   # naming. This can cause naming conflicts when multiple test-suites are run on
   # a single runner.
 
-  # lxd init --auto --storage-backend zfs --storage-pool <name>
   if [ "${LXD_BACKEND}" = "zfs" ]; then
+    # lxd init --auto --storage-backend zfs --storage-pool <name>
     LXD_INIT_DIR=$(mktemp -d -p "${TEST_DIR}" XXX)
     chmod +x "${LXD_INIT_DIR}"
     spawn_lxd "${LXD_INIT_DIR}" false
 
     configure_loop_device loop_file_1 loop_device_1
     # shellcheck disable=SC2154
-
     zpool create "lxdtest-$(basename "${LXD_DIR}")-pool1-existing-pool" "${loop_device_1}" -m none -O compression=on
     LXD_DIR=${LXD_INIT_DIR} lxd init --auto --storage-backend zfs --storage-pool "lxdtest-$(basename "${LXD_DIR}")-pool1-existing-pool"
 
     kill_lxd "${LXD_INIT_DIR}"
-  fi
+    sed -i "\|^${loop_device_1}|d" "${TEST_DIR}/loops"
 
-  # lxd init --auto --storage-backend zfs --storage-pool <name>/<non-existing-dataset>
-  if [ "${LXD_BACKEND}" = "zfs" ]; then
+    # lxd init --auto --storage-backend zfs --storage-pool <name>/<non-existing-dataset>
     LXD_INIT_DIR=$(mktemp -d -p "${TEST_DIR}" XXX)
     chmod +x "${LXD_INIT_DIR}"
     spawn_lxd "${LXD_INIT_DIR}" false
 
-    configure_loop_device loop_file_1 loop_device_1
     # shellcheck disable=SC2154
-
+    configure_loop_device loop_file_1 loop_device_1
     zpool create "lxdtest-$(basename "${LXD_DIR}")-pool1-existing-pool" "${loop_device_1}" -m none -O compression=on
     LXD_DIR=${LXD_INIT_DIR} lxd init --auto --storage-backend zfs --storage-pool "lxdtest-$(basename "${LXD_DIR}")-pool1-existing-pool/non-existing-dataset"
 
     kill_lxd "${LXD_INIT_DIR}"
-  fi
 
-  # lxd init --auto --storage-backend zfs --storage-pool <name>/<existing-dataset>
-  if [ "${LXD_BACKEND}" = "zfs" ]; then
+    # lxd init --auto --storage-backend zfs --storage-pool <name>/<existing-dataset>
     LXD_INIT_DIR=$(mktemp -d -p "${TEST_DIR}" XXX)
     chmod +x "${LXD_INIT_DIR}"
     spawn_lxd "${LXD_INIT_DIR}" false
 
-    # shellcheck disable=SC2154
     zfs create -p -o mountpoint=none "lxdtest-$(basename "${LXD_DIR}")-pool1-existing-pool/existing-dataset"
     LXD_DIR=${LXD_INIT_DIR} lxd init --auto --storage-backend zfs --storage-pool "lxdtest-$(basename "${LXD_DIR}")-pool1-existing-pool/existing-dataset"
 
     kill_lxd "${LXD_INIT_DIR}"
-  fi
+    zpool destroy "lxdtest-$(basename "${LXD_DIR}")-pool1-existing-pool"
+    sed -i "\|^${loop_device_1}|d" "${TEST_DIR}/loops"
 
- # lxd init --storage-backend zfs --storage-create-loop 1 --storage-pool <name> --auto
-  if [ "${LXD_BACKEND}" = "zfs" ]; then
+    # lxd init --storage-backend zfs --storage-create-loop 1 --storage-pool <name> --auto
     LXD_INIT_DIR=$(mktemp -d -p "${TEST_DIR}" XXX)
     chmod +x "${LXD_INIT_DIR}"
     spawn_lxd "${LXD_INIT_DIR}" false
