From 74b8229f53cac9b8a937c414cbcbf27441b9112f Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?St=C3=A9phane=20Graber?= <stgraber@ubuntu.com>
Date: Wed, 28 Jun 2017 15:41:25 -0400
Subject: client: Fix handling of public LXD remote
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Public LXD remotes don't advertise their bound addresses, but they are
still reachable using the URL that was used for the remote.

Closes #3464

Signed-off-by: St√©phane Graber <stgraber@ubuntu.com>
---
 client/lxd.go         | 8 ++++----
 test/suites/remote.sh | 5 +++++
 2 files changed, 9 insertions(+), 4 deletions(-)

diff --git a/client/lxd.go b/client/lxd.go
index df1c6dbf..742ad2fc 100644
--- a/client/lxd.go
+++ b/client/lxd.go
@@ -36,11 +36,11 @@ func (r *ProtocolLXD) GetConnectionInfo() (*ConnectionInfo, error) {
 	info.Protocol = "lxd"
 
 	urls := []string{}
-	if len(r.server.Environment.Addresses) > 0 {
-		if r.httpProtocol == "https" {
-			urls = append(urls, r.httpHost)
-		}
+	if r.httpProtocol == "https" {
+		urls = append(urls, r.httpHost)
+	}
 
+	if len(r.server.Environment.Addresses) > 0 {
 		for _, addr := range r.server.Environment.Addresses {
 			url := fmt.Sprintf("https://%s", addr)
 			if !shared.StringInSlice(url, urls) {
diff --git a/test/suites/remote.sh b/test/suites/remote.sh
index d53ee123..79a168a5 100644
--- a/test/suites/remote.sh
+++ b/test/suites/remote.sh
@@ -117,7 +117,12 @@ test_remote_usage() {
   lxc_remote image show lxd2:bar | grep -q "public: true"
   ! lxc_remote image show bar
   lxc_remote delete pub
+
+  # test spawn from public server
+  lxc_remote remote add lxd2-public "${LXD2_ADDR}" --public --accept-certificate
+  lxc_remote init lxd2-public:bar pub
   lxc_remote image delete lxd2:bar
+  lxc_remote delete pub
 
   # Double launch to test if the image downloads only once.
   lxc_remote init localhost:testimage lxd2:c1 &
