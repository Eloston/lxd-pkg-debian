From 330026da6c06878d4116f2de07499ac207aa8302 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?St=C3=A9phane=20Graber?= <stgraber@ubuntu.com>
Date: Tue, 2 Jan 2018 18:33:37 +0100
Subject: lxd/containers: No slahses in snapshot names
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: St√©phane Graber <stgraber@ubuntu.com>
---
 lxc/snapshot.go           |  8 --------
 lxd/container_snapshot.go | 11 +++++++++++
 2 files changed, 11 insertions(+), 8 deletions(-)

diff --git a/lxc/snapshot.go b/lxc/snapshot.go
index dd3f0a88..bcd59b8b 100644
--- a/lxc/snapshot.go
+++ b/lxc/snapshot.go
@@ -1,10 +1,7 @@
 package main
 
 import (
-	"fmt"
-
 	"github.com/lxc/lxd/lxc/config"
-	"github.com/lxc/lxd/shared"
 	"github.com/lxc/lxd/shared/api"
 	"github.com/lxc/lxd/shared/gnuflag"
 	"github.com/lxc/lxd/shared/i18n"
@@ -48,11 +45,6 @@ func (c *snapshotCmd) run(conf *config.Config, args []string) error {
 		snapname = args[1]
 	}
 
-	// we don't allow '/' in snapshot names
-	if shared.IsSnapshot(snapname) {
-		return fmt.Errorf(i18n.G("'/' not allowed in snapshot name"))
-	}
-
 	remote, name, err := conf.ParseRemote(args[0])
 	if err != nil {
 		return err
diff --git a/lxd/container_snapshot.go b/lxd/container_snapshot.go
index fec770b5..07ea5268 100644
--- a/lxd/container_snapshot.go
+++ b/lxd/container_snapshot.go
@@ -7,6 +7,7 @@ import (
 	"io/ioutil"
 	"net/http"
 	"strconv"
+	"strings"
 
 	"github.com/gorilla/mux"
 
@@ -92,6 +93,11 @@ func containerSnapshotsPost(d *Daemon, r *http.Request) Response {
 		req.Name = fmt.Sprintf("snap%d", i)
 	}
 
+	// Validate the name
+	if strings.Contains(req.Name, "/") {
+		return BadRequest(fmt.Errorf("Snapshot names may not contain slashes"))
+	}
+
 	fullName := name +
 		shared.SnapshotDelimiter +
 		req.Name
@@ -244,6 +250,11 @@ func snapshotPost(d *Daemon, r *http.Request, sc container, containerName string
 		return BadRequest(err)
 	}
 
+	// Validate the name
+	if strings.Contains(newName, "/") {
+		return BadRequest(fmt.Errorf("Snapshot names may not contain slashes"))
+	}
+
 	fullName := containerName + shared.SnapshotDelimiter + newName
 
 	// Check that the name isn't already in use
