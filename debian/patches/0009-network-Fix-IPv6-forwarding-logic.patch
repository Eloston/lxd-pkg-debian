From deaacc573ad4d89e210b8943b22dd541a0816463 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?St=C3=A9phane=20Graber?= <stgraber@ubuntu.com>
Date: Fri, 30 Sep 2016 19:51:37 -0400
Subject: network: Fix IPv6 forwarding logic
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

 - Skipping default and all breaks forwarding so set them too.
 - Make sure to apply all accept_ra changes before changing forwarding policy.
 - Don't mess with accept_ra if it's not set to 1.

Signed-off-by: St√©phane Graber <stgraber@ubuntu.com>
---
 lxd/networks.go | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/lxd/networks.go b/lxd/networks.go
index 66e7551..6a056b4 100644
--- a/lxd/networks.go
+++ b/lxd/networks.go
@@ -833,16 +833,21 @@ func (n *network) Start() error {
 				return err
 			}
 
+			// First set accept_ra to 2 for everything
 			for _, entry := range entries {
-				if entry.Name() == "all" || entry.Name() == "default" {
+				content, err := ioutil.ReadFile(fmt.Sprintf("/proc/sys/net/ipv6/conf/%s/accept_ra", entry.Name()))
+				if err == nil && string(content) != "1\n" {
 					continue
 				}
 
-				err := networkSysctl(fmt.Sprintf("ipv6/conf/%s/accept_ra", entry.Name()), "2")
+				err = networkSysctl(fmt.Sprintf("ipv6/conf/%s/accept_ra", entry.Name()), "2")
 				if err != nil && err != os.ErrNotExist {
 					return err
 				}
+			}
 
+			// Then set forwarding for all of them
+			for _, entry := range entries {
 				err = networkSysctl(fmt.Sprintf("ipv6/conf/%s/forwarding", entry.Name()), "1")
 				if err != nil && err != os.ErrNotExist {
 					return err
