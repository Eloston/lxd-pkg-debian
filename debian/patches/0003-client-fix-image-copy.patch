From f11e66ef4c2ea356251363d4d7dc63bd12d79a7d Mon Sep 17 00:00:00 2001
From: Alberto Donato <alberto.donato@canonical.com>
Date: Mon, 31 Jul 2017 17:15:45 +0200
Subject: client: fix image copy

Signed-off-by: Alberto Donato <alberto.donato@canonical.com>
---
 lxc/image.go          | 30 +++++++-----------------------
 test/suites/remote.sh |  5 ++---
 2 files changed, 9 insertions(+), 26 deletions(-)

diff --git a/lxc/image.go b/lxc/image.go
index 8b214375..2dcbe3a2 100644
--- a/lxc/image.go
+++ b/lxc/image.go
@@ -359,7 +359,7 @@ func (c *imageCmd) run(conf *config.Config, args []string) error {
 		return c.doImageAlias(conf, args)
 
 	case "copy":
-		/* copy [<remote>:]<image> [<rmeote>:]<image> */
+		/* copy [<remote>:]<image> [<remote>:]<image> */
 		if len(args) != 3 {
 			return errArgs
 		}
@@ -388,29 +388,13 @@ func (c *imageCmd) run(conf *config.Config, args []string) error {
 			return err
 		}
 
-		// Attempt to resolve an image alias
-		var imgInfo *api.Image
-		image := inName
-		if c.copyAliases {
-			alias, _, err := d.GetImageAlias(image)
-			if err == nil {
-				image = alias.Target
-			}
-
-			// Get the image info
-			imgInfo, _, err = d.GetImage(image)
-			if err != nil {
-				return err
-			}
-		} else {
-			// Don't fetch full image info if we don't need aliases (since it's
-			// an expensive operation)
-			imgInfo = &api.Image{}
-			imgInfo.Fingerprint = image
-			imgInfo.Public = true
+		image := c.dereferenceAlias(d, inName)
+		imgInfo, _, err := d.GetImage(image)
+		if err != nil {
+			return err
 		}
 
-		if imgInfo.Public && imgInfo.Fingerprint != inName && !strings.HasPrefix(imgInfo.Fingerprint, inName) {
+		if imgInfo.Public && imgInfo.Fingerprint != inName && !strings.HasPrefix(imgInfo.Fingerprint, image) {
 			// If dealing with an alias, set the imgInfo fingerprint to match
 			imgInfo.Fingerprint = inName
 		}
@@ -454,7 +438,7 @@ func (c *imageCmd) run(conf *config.Config, args []string) error {
 				aliases = append(aliases, alias)
 			}
 		}
-		err = ensureImageAliases(dest, aliases, image)
+		err = ensureImageAliases(dest, aliases, imgInfo.Fingerprint)
 		return err
 
 	case "delete":
diff --git a/test/suites/remote.sh b/test/suites/remote.sh
index 79a168a5..301de89a 100644
--- a/test/suites/remote.sh
+++ b/test/suites/remote.sh
@@ -147,9 +147,8 @@ test_remote_usage() {
   mv "${LXD_CONF}/client.crt" "${LXD_CONF}/client.crt.bak"
   mv "${LXD_CONF}/client.key" "${LXD_CONF}/client.key.bak"
 
-  # testimage should still exist on the local server.  Count the number of
-  # matches so the output isn't polluted with the results.
-  lxc_remote image list local: | grep -c testimage
+  # testimage should still exist on the local server.
+  lxc_remote image list local: | grep -q testimage
 
   # Skip the truly remote servers in offline mode.  There should always be
   # Ubuntu images in the results for the remote servers.
