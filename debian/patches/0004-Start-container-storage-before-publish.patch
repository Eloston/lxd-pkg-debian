From d80e7706005beac4ef5020ebb23f2fc8da98f882 Mon Sep 17 00:00:00 2001
From: Michael McCracken <mike.mccracken@canonical.com>
Date: Wed, 30 Sep 2015 11:38:18 -0700
Subject: Start container storage before publish

Fixes publishing LVM-backed snaps and containers.

Signed-off-by: Michael McCracken <mike.mccracken@canonical.com>
---
 lxd/container.go   | 5 +++++
 test/suites/lvm.sh | 3 +++
 2 files changed, 8 insertions(+)

diff --git a/lxd/container.go b/lxd/container.go
index e9b677f..f514698 100644
--- a/lxd/container.go
+++ b/lxd/container.go
@@ -1257,6 +1257,11 @@ func (c *containerLXD) ExportToTar(snap string, w io.Writer) error {
 		return fmt.Errorf("Cannot export a running container as image")
 	}
 
+	if err := c.StorageStart(); err != nil {
+		return err
+	}
+	defer c.StorageStop()
+
 	idmap, err := c.LastIdmapSetGet()
 	if err != nil {
 		return err
diff --git a/test/suites/lvm.sh b/test/suites/lvm.sh
index 8e2fa7b..9f276c6 100644
--- a/test/suites/lvm.sh
+++ b/test/suites/lvm.sh
@@ -225,6 +225,9 @@ test_lvm_withpool() {
     lvs ${VGNAME}/test--container-superchill || die "superchill should exist"
     lvs ${VGNAME}/test--container-chillbro && die "chillbro should not exist"
 
+    lxc publish test-container || die "Couldn't publish test-container"
+    lxc publish test-container/unchillbro || die "Couldn't publish snapshot"
+
     # TODO busybox ignores SIGPWR, breaking restart:
     # check that 'shutdown' also unmounts:
     # lxc start test-container || die "Couldn't re-start test-container"
