From e2e3672cc3c69efc06832cbd68b19fcecb9580c2 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?St=C3=A9phane=20Graber?= <stgraber@ubuntu.com>
Date: Tue, 22 Aug 2017 20:36:22 -0400
Subject: Attempt to restore the auto_update property
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Fixes a regression in image update in LXD 2.0.10.

Signed-off-by: St√©phane Graber <stgraber@ubuntu.com>
---
 lxd/patches.go | 25 +++++++++++++++++++++++++
 1 file changed, 25 insertions(+)

diff --git a/lxd/patches.go b/lxd/patches.go
index 94f9655e..b1dc3504 100644
--- a/lxd/patches.go
+++ b/lxd/patches.go
@@ -29,6 +29,7 @@ import (
 var patches = []patch{
 	{name: "invalid_profile_names", run: patchInvalidProfileNames},
 	{name: "leftover_profile_config", run: patchLeftoverProfileConfig},
+	{name: "cached_images_update", run: patchCachedImagesUpdate},
 }
 
 type patch struct {
@@ -106,3 +107,27 @@ func patchInvalidProfileNames(name string, d *Daemon) error {
 
 	return nil
 }
+
+func patchCachedImagesUpdate(name string, d *Daemon) error {
+	images, err := dbImagesGet(d.db, false)
+	if err != nil {
+		return err
+	}
+
+	for _, fp := range images {
+		id, image, err := dbImageGet(d.db, fp, false, true)
+		if err != nil {
+			return err
+		}
+
+		if image.Cached && !image.AutoUpdate && image.UpdateSource != nil {
+			stmt := `UPDATE images SET auto_update=1 WHERE id=?`
+			_, err := dbExec(d.db, stmt, id)
+			if err != nil {
+				return err
+			}
+		}
+	}
+
+	return nil
+}
